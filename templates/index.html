<!DOCTYPE html>
<html>
<head>
    <title>PowerMonitor</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .collapsible {
            cursor: pointer;
            list-style: none;
            padding: 2px;
            border: 1px solid #ccc;
            margin-bottom: 2px;
        }

        .collapsible.active {
            background-color: #f9f9f9;
        }

        .content {
            margin-top: 2px;
            overflow: hidden;
            height: 1.6em;
            line-height: 1.6em;
        }

        .content.collapsed {
            height: 1.6em;
        }

        .collapsible.active .content {
            height: auto;
        }

        .container {
            display: flex;
        }

        #minute-detail-list {
            width: 35%;
            height: 100vh;
            overflow-y: scroll;
            border-right: 1px solid #ccc;
            padding: 10px;
        }

        #file-content {
            flex: 1;
            height: 100vh;
            overflow-y: scroll;
            padding: 10px;
            margin-left: 15px;
        }

        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .tab-buttons {
            margin-bottom: 10px;
        }

        .tab-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
        }
        .rounder_corner {
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* New style for the copy icon */
        .copy-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

                /* New style for the copy icon */
        .file-content {
            position: relative;
        }

        #bar-graph {
            width: 100%;
            height: 500px; /* Set the initial height */
            position: relative;
        }
    </style>
</head>
<body>
<div class="tab-buttons">
    <button id="request-per-hour-button" onclick="switchTab('request-per-hour')">JAWS Server Stats</button>
    <button id="empty-tab-button" onclick="switchTab('empty-tab')">Empty Tab</button>
</div>
<div id="main-frame">
    <div id="request-per-hour" class="tab active">
        <div id="bar-graph" class="rounder_corner"></div>
        <button id="back-button">Back</button>
        <div class="container">
            <div class="rounder_corner" id="minute-detail-list"></div>
            <div class="rounder_corner"  id="file-content"></div>
        </div>
    </div>
    <div id="empty-tab" class="tab">
        <h1>Empty Tab</h1>
    </div>
</div>

<script>
    // Function to load the initial bar graph data
    var isViewingDetailedData = false;

    function loadBarGraph() {
        if (!isViewingDetailedData) {
            fetch('/graph_data')
                .then(response => response.json())
                .then(data => {
                    var parsedData = JSON.parse(data);
                    Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
                        .then(function(gd) {
                            gd.on('plotly_click', handleBarClick);
                        });
                });
            setTimeout(loadBarGraph, 30000);  // Call this function again after 30 seconds

                    // Add resize event listener to dynamically resize the plot
            window.addEventListener('resize', function() {
                var container = document.getElementById('bar-graph');
                var width = container.offsetWidth;

                Plotly.relayout('bar-graph', {
                    width: width
                });
            });
        }
    }

    function handleBarClick(event) {
        if (event && event.points) {
            var timestamp = event.points[0].x;
            var encodedTimestamp = encodeURIComponent(timestamp);

            var pointNumber = event.points[0].pointNumber;
            var traceIndex = event.points[0].curveNumber;

            if (isViewingDetailedData) {
                // Get the Plotly figure
                var graphDiv = document.getElementById('bar-graph');
                var data = graphDiv.data;

                // Get the status from the trace name
                var status = data[traceIndex].name;

                fetch('/graph_data/' + encodedTimestamp + '/' + status)
                    .then(response => response.json())
                    .then(data => {
                        var minuteDetailList = document.getElementById('minute-detail-list');
                        minuteDetailList.innerHTML = ''; // Clear previous content
                        console.log(data);
                        // Iterate over the data and create HTML elements
                        data.forEach(item => {
                            var listItem = document.createElement('li');
                            listItem.classList.add('collapsible'); // Add the 'collapsible' class to the listItem

                            var contentContainer = document.createElement('div');
                            contentContainer.classList.add('content', 'collapsed'); // Add the 'content' and 'collapsed' classes to the contentContainer

                            createRequestDetails(item, contentContainer);

                            var button1 = createDownloadButton('/process_file_location', 'ServiceRequest', item.sr_requestfile);
                            var button2 = createDownloadButton('/process_file_location', 'ServiceResponse', item.sr_responsefile);
                            var button3 = createDownloadButton('/process_file_location', 'Request', item.requestfile);
                            var button4 = createDownloadButton('/process_file_location', 'Response', item.responsefile);


                            // Append the button to the content container
                            contentContainer.appendChild(button1);
                            contentContainer.appendChild(button2);
                            contentContainer.appendChild(button3);
                            contentContainer.appendChild(button4);

                            listItem.appendChild(contentContainer);
                            minuteDetailList.appendChild(listItem);
                        });

                        // Add click event listener to each collapsible item
                        var collapsibleItems = document.querySelectorAll('.collapsible');
                        collapsibleItems.forEach(item => {
                            item.addEventListener('click', function() {
                                this.classList.toggle('active'); // Toggle the 'active' class
                            });
                        });
                    });
            } else {
                isViewingDetailedData = true;
                fetch('/graph_data/' + encodedTimestamp)
                    .then(response => response.json())
                    .then(data => {
                        var parsedData = JSON.parse(data);
                        Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
                            .then(function(gd) {
                                gd.on('plotly_click', handleBarClick);
                            });
                    });
            }
        }
    }

    function handleBackButtonClick() {
        isViewingDetailedData = false;
        loadBarGraph();

        var minuteDetailList = document.getElementById('minute-detail-list');
        minuteDetailList.innerHTML = ''; // Clear the minute detail list

        var fileContent = document.getElementById('file-content');
        fileContent.textContent = ''; // Clear the file content
    }

    function displayFormattedXML(data) {
        var fileContentColumn = document.getElementById('file-content');
        fileContentColumn.innerHTML = ''; // Clear previous content

        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(data, 'application/xml');
        var formattedXML = new XMLSerializer().serializeToString(xmlDoc);

        var pre = document.createElement('pre');
        pre.textContent = formattedXML;

        fileContentColumn.appendChild(pre);
    }

    function createDownloadButton(url, label, responsefile) {
        var button = document.createElement('button');
        button.textContent = label;
                
          // Disable the button if responsefile is empty or null
          if (!responsefile) {
            button.disabled = true;
          }

         button.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent event propagation
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ responsefile_path: responsefile })
            })
            .then(response => {
                if (response.ok) {
                    return response.text(); // or response.json() if the response is JSON
                } else {
                    throw new Error('Request failed with status ' + response.status);
                }
            })
            .then(data => {
                console.log('Response:', data); // Log the full response
                displayFormattedXML(data); // Display the response in the file-content column

    // Add the copy icon to the file-content div
    var fileContentDiv = document.getElementById('file-content');
    fileContentDiv.classList.add('file-content');
    var copyIcon = document.createElement('span');
    copyIcon.innerHTML = '&#128203;'; // Unicode for clipboard icon (ðŸ“‹)
    copyIcon.classList.add('copy-icon');
    copyIcon.addEventListener('click', copyFileContents);
    fileContentDiv.appendChild(copyIcon);
            })
            .catch(error => {
                console.error('An error occurred while processing file location', error);
            });

        });

        return button;
    }

    function createRequestDetails(item, contentContainer) {
      var valueSpan = document.createElement('span');
      valueSpan.textContent = item['brokername'];
      contentContainer.appendChild(valueSpan);

      valueSpan = document.createElement('span');
      valueSpan.textContent = item['pq_clientid'];
      contentContainer.appendChild(valueSpan);

      contentContainer.appendChild(document.createElement('br')); // Add a line break

        if (item['subbrokerid']) {
          valueSpan = document.createElement('span');
          valueSpan.textContent = 'Subbroker: ' + item['subbrokerid'];
          contentContainer.appendChild(valueSpan);
          contentContainer.appendChild(document.createElement('br')); // Add a line break
        }

      valueSpan = document.createElement('span');
        var lob_text;
        if (item['lob'].charAt(0) === '1') {
          lob_text = 'Auto';
        } else if (item['lob'].charAt(0) === '2') {
          lob_text = 'Home';
        } else {
          lob_text = 'Credit';
        }


      valueSpan.textContent = item['insurer'] + ' ' + lob_text + ' ' + item['prov'];
      contentContainer.appendChild(valueSpan);

      contentContainer.appendChild(document.createElement('br')); // Add a line break
    }

    function switchTab(tabId) {
        var tabs = document.getElementsByClassName('tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }

        var buttons = document.getElementsByClassName('tab-buttons')[0].getElementsByTagName('button');
        for (var j = 0; j < buttons.length; j++) {
            buttons[j].classList.remove('active');
        }

        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabId + '-button').classList.add('active');
    }


    document.addEventListener('DOMContentLoaded', function() {
        loadBarGraph();

        var backButton = document.getElementById('back-button');
        backButton.addEventListener('click', handleBackButtonClick);

        var mainTab = document.getElementById('request-per-hour-button');
        mainTab.addEventListener('click', handleBackButtonClick);
    });

    // Function to copy file contents to clipboard
    function copyFileContents() {
        var fileContent = document.getElementById('file-content');
        var range = document.createRange();
        range.selectNodeContents(fileContent);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        document.execCommand('copy');
        selection.removeAllRanges();
    }

</script>
</body>
</html>
