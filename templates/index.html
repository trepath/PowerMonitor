<!DOCTYPE html>
<html>
<head>
    <title>PowerMonitor</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
.status-0 {
  background-color: hsl(120, 50%, 85%);
}

.status-1 {
  background-color: hsl(120, 50%, 85%);
}

.status-500 {
  background-color: hsl(0, 0%, 80%);
}

.status-504 {
  background-color: hsl(0, 100%, 95%);
}

.status-403 {
  background-color: hsl(30, 100%, 75%);
}

.status-2 {
  background-color: hsl(0, 100%, 75%);
}

.status-6 {
  background-color: hsl(30, 50%, 75%);
}

.status-400 {
  background-color: hsl(240, 100%, 75%);
}

.status-200 {
  background-color: hsl(120, 50%, 85%);
}

        .collapsible {
            cursor: pointer;
            list-style: none;
            padding: 2px;
            border: 1px solid #ccc;
            margin-bottom: 2px;
        }

        .collapsible.active {
            background-color: #f9f9f9;
        }

        .content {
            margin-top: 2px;
            overflow: hidden;
            height: 1.6em;
            line-height: 1.6em;
        }

        .content.collapsed {
            height: 1.6em;
        }

        .collapsible.active .content {
            height: auto;
        }

        .container {
            display: flex;
        }

        #minute-detail-list {
            width: 35%;
            height: 100vh;
            overflow-y: scroll;
            border-right: 1px solid #ccc;
            padding: 10px;
        }

        #insurer-detail-list {
            width: 35%;
            height: 100vh;
            overflow-y: scroll;
            border-right: 1px solid #ccc;
            padding: 10px;
        }

        #current-broker-details{
            width: 35%;
            height: 100vh;
            overflow-y: scroll;
            border-right: 1px solid #ccc;
            padding: 10px;
        }

        #file-content {
            flex: 1;
            height: 100vh;
            overflow-y: scroll;
            padding: 10px;
            margin-left: 15px;
        }

        #insurer-file-content {
            flex: 1;
            height: 100vh;
            overflow-y: scroll;
            padding: 10px;
            margin-left: 15px;
        }

        #current-broker-stats{
            flex: 1;
            height: 100vh;
            overflow-y: scroll;
            padding: 10px;
            margin-left: 15px;
        }

        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .tab-buttons {
            margin-bottom: 10px;
        }

        .tab-buttons button {
            padding: 5px 10px;
            margin-right: 5px;
        }
        .rounder_corner {
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* New style for the copy icon */
        .copy-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

                /* New style for the copy icon */
        .file-content {
            position: relative;
        }

        #bar-graph {
            width: 100%;
            height: 500px; /* Set the initial height */
            position: relative;
        }

        #bar-graph {
            width: 100%;
            height: 500px; /* Set the initial height */
            position: relative;
        }

        .list {
            display: flex;
            flex-direction: column;
        }

        .list div:nth-child(even) {
            background-color: #f2f2f2; /* Lighter grey color */
        }

        .list div:nth-child(odd) {
            background-color: white;
        }

        .plot-container {
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #quoting-history-pie-chart {
            margin-left: 10px;
        }
        @keyframes flashRed {
            0%, 100% { background-color: red; color: white; }
            50% { background-color: white; color: red; }
        }

        .flash-red {
            animation: flashRed 1s infinite;
        }

        #health-check-status-container span {
        margin-left: auto; /* Push the status to the right */
        padding: 5px; /* Optional padding */
        }

        .side-by-side-container {
            display: flex;
            gap: 10px; /* Optional: adds space between the two divs */
        }

        #bar-graph {
            flex: 8;
        }

        #current-broker-graph {
            flex: 8;
        }

        #hourly-request-graph {
            flex: 8;
        }

        .server-status {
            flex: 2;
        }
    </style>
</head>
<body>
<div class="tab-buttons">
    <button id="request-per-hour-button" onclick="switchTab('request-per-hour')">JAWS Server Stats</button>
    <button id="company-status-button" onclick="switchTab('company-status')">Company Status</button>
    <button id="broker-status-button" onclick="switchTab('broker-status')">Broker Stats</button>
    <!-- New element for displaying health check status -->
    <span id="health-check-status-container" style="color: red; font-weight: bold;"></span>
    <!-- <span id="health-check-status-container"></span>-->
</div>
<div id="main-frame">
    <div id="request-per-hour" class="tab active">
        <!-- Add side bar with server status -->
        <div class="side-by-side-container">
            <div id="bar-graph" class="rounder_corner"></div>
            <div class="rounder_corner server-status">Servernames</div>
        </div>

        <button id="back-button">Back</button>
        <select id="server-dropdown">
            <option value="Production">Production</option>
            <option value="Testing">Testing</option>
        </select>
        <select id="broker-dropdown">
            <!-- Broker options will be populated here by JavaScript -->
        </select>
        <div class="container">
            <div class="rounder_corner" id="minute-detail-list"></div>
            <div class="rounder_corner"  id="file-content"></div>
        </div>
    </div>
    <div id="company-status" class="tab">
                <!-- Add side bar with server status -->
        <div class="side-by-side-container">
            <div id="hourly-graph" class="rounder_corner"></div>
            <div class="rounder_corner server-status">Servernames</div>
        </div>

        <div class="container">
            <div class="rounder_corner" id="insurer-detail-list"></div>
            <div class="rounder_corner"  id="insurer-file-content"></div>
        </div>
    </div>
    <div id="broker-status" class="tab">
                <!-- Add side bar with server status -->
        <div class="side-by-side-container">
            <div id="current-broker-graph" class="rounder_corner"></div>
            <div class="rounder_corner server-status">Servernames</div>
        </div>

        <select id="current-broker-dropdown">
            <!-- Broker options will be populated here by JavaScript -->
        </select>
        <div class="container">
            <div class="rounder_corner" id="current-broker-details"></div>
            <div class="rounder_corner"  id="current-broker-stats"></div>
        </div>
    </div>
</div>

<script>
    // Function to load the initial bar graph data
    var isViewingDetailedData = false;
    var lastEncodedTimestamp = '';
    var lastStatus = '';

    function loadBarGraph() {
        console.log('Loading bar graph data...');
        var dropdown = document.getElementById('broker-dropdown');
        var selectedBroker = dropdown.value;  // Get the selected broker pq_clientid
        if (selectedBroker === '') {
            selectedBroker = 'None';
        }

        var dropdownServer = document.getElementById('server-dropdown');
        var selectedServer = dropdownServer.value;  // Get the selected server

        console.log('Selected Broker: ' + selectedBroker);
        if (!isViewingDetailedData) {
            // Include selectedBroker in the URL only when it is not 'None'
            //var url = '/graph_data_client/' + (selectedBroker !== 'None' ? selectedBroker : '');
            var url = '/graph_data_client/' + selectedBroker + '/' + selectedServer;
            console.log('url:' + url);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var parsedData = JSON.parse(data);
                    Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
                        .then(function(gd) {
                            gd.on('plotly_click', handleBarClick);
                        });
                });
            setTimeout(loadBarGraph, 60000);  // Call this function again after 60 seconds

            // Add resize event listener to dynamically resize the plot

            window.addEventListener('resize', function() {
                var container = document.getElementById('bar-graph');
                var width = container.offsetWidth;

                Plotly.relayout('bar-graph', {
                    width: width
                });
            });
        }else{
            console.log('Loading minute detail data...');
            var dropdownServer = document.getElementById('server-dropdown');
            var selectedServer = dropdownServer.value;  // Get the selected server
            url = '/graph_data/' + lastEncodedTimestamp + '?pq_clientid=' + selectedBroker+"-"+selectedServer;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var parsedData = JSON.parse(data);
                    Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
                        .then(function(gd) {
                            gd.on('plotly_click', handleBarClick);
                        });
                });
        }
    }

    function handleBarClick(event) {
        if (event && event.points) {
            var timestamp = event.points[0].x;
            var encodedTimestamp = encodeURIComponent(timestamp);

            var pointNumber = event.points[0].pointNumber;
            var traceIndex = event.points[0].curveNumber;

            var dropdown = document.getElementById('broker-dropdown');
            var selectedBroker = dropdown.value;  // Get the selected broker pq_clientid
            if (selectedBroker === '') {
                selectedBroker = 'None';
            }

            var dropdownServer = document.getElementById('server-dropdown');
            var selectedServer = dropdownServer.value;  // Get the selected server

            if (isViewingDetailedData) {
                // Get the Plotly figure
                var graphDiv = document.getElementById('bar-graph');
                var data = graphDiv.data;

                // Get the status from the trace name
                var status = data[traceIndex].name;
                console.log('Status: ' + selectedServer);
                fetch('/minute_breakdown_details/' + encodedTimestamp + '/' + status + '/' + selectedServer)
                    .then(response => response.json())
                    .then(data => {
                    var minuteDetailList = document.getElementById('minute-detail-list');
                    minuteDetailList.innerHTML = ''; // Clear previous content
                    console.log(data);

                    var itemMap = new Map(); // Create a map to group items by srnumber

                    // Iterate over the data and group items by srnumber
                    data.forEach(item => {
                      if (item.pq_clientid == selectedBroker || selectedBroker == 'None') {
                        if (!itemMap.has(item.srnumber)) {
                          itemMap.set(item.srnumber, []);
                        }
                        itemMap.get(item.srnumber).push(item);
                      }
                    });

                    // Iterate over the grouped items and create HTML elements
                    itemMap.forEach((items, srnumber) => {
                      var listItem = document.createElement('li');
                      listItem.classList.add('collapsible'); // Add the 'collapsible' class to the listItem

                      var contentContainer = document.createElement('div');
                      contentContainer.classList.add('content', 'collapsed'); // Add the 'content' and 'collapsed' classes to the contentContainer
                      console.log(itemMap);
                      contentContainer.id = items[0]['srnumber'];
                      createRequestDetails(items[0], contentContainer);

                        contentContainer.appendChild(document.createElement('br')); // Add a line break

                      items.forEach(item => {
                        var itemContainer = document.createElement('div');
                        //createRequestDetails(item, itemContainer);
                            itemContainer.classList.add('status-' + item['status']); // Add the 'content' and 'collapsed' classes to the contentContainer

                            valueSpan = document.createElement('span');
                            var lob_text;
                            if (item['lob'].charAt(0) === '1') {
                              lob_text = 'Auto';
                            } else if (item['lob'].charAt(0) === '2') {
                              lob_text = 'Home';
                            } else {
                              lob_text = 'Credit';
                            }

                          valueSpan.textContent = item['insurer'] + ' ' + lob_text + ' ' + item['prov'];
                          valueSpan.style.cssFloat = 'left'; // Align to the left
                          itemContainer.appendChild(valueSpan);

                          responsetimeSpan = document.createElement('span');
                          responsetimeSpan.textContent = 'Response Time: ' + item['responsetime'];
                          responsetimeSpan.style.cssFloat = 'right'; // Align to the right
                          itemContainer.appendChild(responsetimeSpan);

                            itemContainer.appendChild(document.createElement('br')); // Add a line break

                          serverSpan = document.createElement('span');
                          serverSpan.textContent = item['servername'];
                          serverSpan.style.cssFloat = 'right'; // Align to the right
                          itemContainer.appendChild(serverSpan);



                        var button3 = createDownloadButton('/process_file_location', 'Request', item.requestfile);
                        var button4 = createDownloadButton('/process_file_location', 'Response', item.responsefile);

                        // Append the buttons to the item container
                        itemContainer.appendChild(button3);
                        itemContainer.appendChild(button4);

                        // Append the item container to the content container
                        contentContainer.appendChild(itemContainer);
                      });

                      listItem.appendChild(contentContainer);
                      minuteDetailList.appendChild(listItem);

                        // Add click event listener to toggle collapsing/expanding of the list item
                        listItem.addEventListener("click", function () {
                            var listItems = document.getElementsByClassName("collapsible");
                            for (var i = 0; i < listItems.length; i++) {
                                if (listItems[i] !== this) {
                                    listItems[i].classList.remove("active");
                                    var content = listItems[i].querySelector(".content");
                                    content.classList.add("collapsed");
                                }
                            }

                            this.classList.toggle("active");
                            var content = this.querySelector(".content");
                            content.classList.toggle("collapsed");
                        });
                    });


                    });
            } else {
                isViewingDetailedData = true;
                console.log('Loading minute detail data...');
                var dropdownServer = document.getElementById('server-dropdown');
                var selectedServer = dropdownServer.value;  // Get the selected server
                lastEncodedTimestamp = encodedTimestamp;
                url = '/graph_data/' + encodedTimestamp + '?pq_clientid=' + selectedBroker+"-"+selectedServer;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        var parsedData = JSON.parse(data);
                        Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
                            .then(function(gd) {
                                gd.on('plotly_click', handleBarClick);
                            });
                    });
            }
        }
    }


    function handleBackButtonClick() {
        isViewingDetailedData = false;

        loadBrokers();
        console.log('Back Button calling loadbargraph...');
        loadBarGraph();

        var minuteDetailList = document.getElementById('minute-detail-list');
        minuteDetailList.innerHTML = ''; // Clear the minute detail list

        var fileContent = document.getElementById('file-content');
        fileContent.textContent = ''; // Clear the file content
    }

    function displayFormattedXML(data) {
        var fileContentColumn = document.getElementById('file-content');
        fileContentColumn.innerHTML = ''; // Clear previous content

        var fileContentColumn2 = document.getElementById('insurer-file-content');
        fileContentColumn2.innerHTML = ''; // Clear previous content

        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(data, 'application/xml');
        var formattedXML = new XMLSerializer().serializeToString(xmlDoc);

        var pre = document.createElement('pre');
        pre.textContent = formattedXML;

        var pre2 = pre.cloneNode(true);

        fileContentColumn.appendChild(pre);
        fileContentColumn2.appendChild(pre2);
    }

    function createDownloadButton(url, label, responsefile) {
        var button = document.createElement('button');
        button.textContent = label;
                
          // Disable the button if responsefile is empty or null
          if (!responsefile) {
            button.disabled = true;
          }

         button.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent event propagation
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ responsefile_path: responsefile })
            })
            .then(response => {
                if (response.ok) {
                    return response.text(); // or response.json() if the response is JSON
                } else {
                    throw new Error('Request failed with status ' + response.status);
                }
            })
            .then(data => {
                //console.log('Response:', data); // Log the full response
                displayFormattedXML(data); // Display the response in the file-content column

                // Add the copy icon to the file-content div
                var fileContentDiv = document.getElementById('file-content');
                fileContentDiv.classList.add('file-content');
                var copyIcon = document.createElement('span');
                copyIcon.innerHTML = '&#128203;'; // Unicode for clipboard icon (📋)
                copyIcon.classList.add('copy-icon');
                copyIcon.addEventListener('click', copyFileContents);
                fileContentDiv.appendChild(copyIcon);
            })
            .catch(error => {
                console.error('An error occurred while processing file location', error);
            });

        });

        return button;
    }

    function createRequestDetails(item, contentContainer) {
        console.log('Creating request details...');
        // Clear the contentContainer
        contentContainer.innerHTML = '';
      var valueSpan = document.createElement('span');
      valueSpan.textContent = item['brokername'];
      contentContainer.appendChild(valueSpan);

      valueSpan = document.createElement('span');
      valueSpan.textContent = item['pq_clientid'];
      contentContainer.appendChild(valueSpan);

      quoteNumberSpan = document.createElement('span');
        quoteNumberSpan.textContent = item['quotenumber'];
        quoteNumberSpan.style.cssFloat = 'right'; // Align to the right
        contentContainer.appendChild(quoteNumberSpan);

      contentContainer.appendChild(document.createElement('br')); // Add a line break

        if (item['subbrokerid']) {
          subbrokeridSpan = document.createElement('span');
          subbrokeridSpan.textContent = 'Subbroker: ' + item['subbrokerid'];
          contentContainer.appendChild(subbrokeridSpan);
          contentContainer.appendChild(document.createElement('br')); // Add a line break
        }

        if (item['username']) {
          usernameSpan = document.createElement('span');
          usernameSpan.textContent = 'Username: ' + item['username'];
          contentContainer.appendChild(usernameSpan);
          contentContainer.appendChild(document.createElement('br')); // Add a line break
        }


        var button1 = createDownloadButton('/process_file_location', 'ServiceRequest', item.sr_requestfile);
        var button2 = createDownloadButton('/process_file_location', 'ServiceResponse', item.sr_responsefile);

        // Append the buttons to the item container
        contentContainer.appendChild(button1);
        contentContainer.appendChild(button2);

      contentContainer.appendChild(document.createElement('br')); // Add a line break
    }

    function switchTab(tabId) {
        console.log('Switching tab to ' + tabId);
        var fileContentColumn = document.getElementById('file-content');
        fileContentColumn.innerHTML = ''; // Clear previous content

        var fileContentColumn2 = document.getElementById('insurer-file-content');
        fileContentColumn2.innerHTML = ''; // Clear previous content

        var tabs = document.getElementsByClassName('tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }

        var buttons = document.getElementsByClassName('tab-buttons')[0].getElementsByTagName('button');
        for (var j = 0; j < buttons.length; j++) {
            buttons[j].classList.remove('active');
        }

        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabId + '-button').classList.add('active');

        window.dispatchEvent(new Event('resize'));  // Dispatch resize event

        loadTopBrokers();
    }

    function handleServerDropDownChange() {
        var serverDropdown = document.getElementById('server-dropdown');

        var selectedServer = serverDropdown.value;
        console.log('Selected Server:', selectedServer);
        // Clear the contentContainer
        var detailsContainer = document.getElementById('minute-detail-list');
        detailsContainer.innerHTML = '';

        // Clear the file-content
        var fileContentDiv = document.getElementById('file-content');
        fileContentDiv.innerHTML = '';

        loadBrokers();
        console.log('Serverdropdownchange calling loadbargraph...');
        loadBarGraph();
        // Perform actions based on the selected server value
        // For example, you can reload data specific to the selected server
    }

    function refilter(){
        console.log('Refiltering data');
        isViewingDetailedData = false;
        // Clear the contentContainer
        var detailsContainer = document.getElementById('minute-detail-list');
        detailsContainer.innerHTML = '';

        // Clear the file-content
        var fileContentDiv = document.getElementById('file-content');
        fileContentDiv.innerHTML = '';

        console.log('Refilter calling loadbargraph...');
        loadBarGraph();

        console.log('Reloading minute detail data...');
        var dropdownServer = document.getElementById('server-dropdown');
        var selectedServer = dropdownServer.value;  // Get the selected server

        var dropdown = document.getElementById('broker-dropdown');
        var selectedBroker = dropdown.value;  // Get the selected broker pq_clientid
        if (selectedBroker === '') {
            selectedBroker = 'None';
        }

        //url = '/graph_data/' + lastEncodedTimestamp + '?pq_clientid=' + selectedBroker+"-"+selectedServer;
        //fetch(url)
        //    .then(response => response.json())
        //    .then(data => {
        //        var parsedData = JSON.parse(data);
        //        Plotly.newPlot('bar-graph', parsedData.data, parsedData.layout)
        //            .then(function(gd) {
        //                gd.on('plotly_click', handleBarClick);
        //            });
        //    });
    }

    // Function to copy file contents to clipboard
    function copyFileContents() {
        var fileContent = document.getElementById('file-content');
        var range = document.createRange();
        range.selectNodeContents(fileContent);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        document.execCommand('copy');
        selection.removeAllRanges();
    }

    function loadBrokers() {
        var dropdownServer = document.getElementById('server-dropdown');
        var selectedServer = dropdownServer.value;  // Get the selected server

        fetch('/brokers/'+selectedServer)
            .then(response => response.json())
            .then(data => {
            console.log('Brokers:', data);
                var dropdown = document.getElementById('broker-dropdown');
                // Clear old options
                dropdown.innerHTML = '';
                // Add a default option
                var defaultOption = document.createElement('option');
                defaultOption.value = 'None';
                defaultOption.textContent = 'All brokers';
                dropdown.appendChild(defaultOption);
                // Sort data by broker name
                data.sort((a, b) => a[0].localeCompare(b[0]));
                // Add an option for each broker
                data.forEach(broker => {
                    var option = document.createElement('option');
                    option.value = broker[1]; // pq_clientid
                    option.textContent = broker[0]; // brokername
                    dropdown.appendChild(option);
                });
            });
    }

    function loadHourlyGraph() {
        console.log('Loading hourly graph data...');

        fetch('/graph_data_last_hour')
            .then(response => response.json())
            .then(data => {
                var parsedData = JSON.parse(data);

                // Get the container's size
                var container = document.getElementById('hourly-graph');
                var layout = {
                    ...parsedData.layout,
                    width: container.offsetWidth,
                    height: container.offsetHeight
                };

                Plotly.newPlot('hourly-graph', parsedData.data, layout)
                    .then(function(gd) {
                        gd.on('plotly_click', handleHourlyGraphClick);
                    });

                window.dispatchEvent(new Event('resize'));  // Dispatch resize event
            });

        setTimeout(loadHourlyGraph, 60000);  // Call this function again after 1 minute

        // Add resize event listener to dynamically resize the plot
        window.addEventListener('resize', function() {
            var container = document.getElementById('hourly-graph');
            var width = container.offsetWidth;

            Plotly.relayout('hourly-graph', {
                width: width
            });
        });
    }

    function loadServers() {
        fetch('/servers')
            .then(response => response.json())
            .then(data => {
                var dropdown = document.getElementById('server-dropdown-hourly');
                // Clear old options
                dropdown.innerHTML = '';
                // Add a default option
                var defaultOption = document.createElement('option');
                defaultOption.value = 'None';
                defaultOption.textContent = 'All servers';
                dropdown.appendChild(defaultOption);
                // Add an option for each server
                data.forEach(server => {
                    var option = document.createElement('option');
                    option.value = server;
                    option.textContent = server;
                    dropdown.appendChild(option);
                });
            });
    }

    function populateCurrentBroker(){
            fetch('/current-brokers')
            .then(response => response.json())
            .then(data => {
                var dropdown = document.getElementById('current-broker-dropdown');
                // Clear old options
                dropdown.innerHTML = '';
                // Add a default option
                var defaultOption = document.createElement('option');
                defaultOption.value = 'None';
                defaultOption.textContent = 'All Brokers';
                dropdown.appendChild(defaultOption);
                // Add an option for each server
                data.forEach(server => {
                    var option = document.createElement('option');
                    option.value = server;
                    option.textContent = server;
                    dropdown.appendChild(option);
                });
            });
    }

    function handleHourlyGraphClick(event) {
        if (event && event.points) {

            var insurer = event.points[0].y;
            console.log('Insurer: ', insurer);  // This should log the insurer when you click on a bar
            loadInsurerDetail(insurer,event);  // This function should be defined to load the details for the clicked insurer
        }
    }

    function loadInsurerDetail(insurer,event){
            var timestamp = event.points[0].x;
            var encodedTimestamp = encodeURIComponent(timestamp);

            var pointNumber = event.points[0].pointNumber;
            var traceIndex = event.points[0].curveNumber;
            var dropdown = document.getElementById('broker-dropdown');
            var selectedBroker = dropdown.value;  // Get the selected broker pq_clientid
            if (selectedBroker === '') {
                selectedBroker = 'None';
            }

            var dropdownServer = document.getElementById('server-dropdown');
            var selectedServer = dropdownServer.value;  // Get the selected server

                    // Get the Plotly figure
                var graphDiv = document.getElementById('bar-graph');
                var data = graphDiv.data;

                // Get the status from the trace name
                var status = event.points[0].data.name;
                console.log('Status: ' + status);
                fetch('/insurer_breakdown/' + '1' + '/' + status + '/' + insurer.trim() + '/' + selectedServer)
                    .then(response => response.json())
                    .then(data => {
                        var minuteDetailList = document.getElementById('insurer-detail-list');
                    minuteDetailList.innerHTML = ''; // Clear previous content
                    console.log(data);

                    var itemMap = new Map(); // Create a map to group items by srnumber

                    // Iterate over the data and group items by srnumber
                    data.forEach(item => {
                      if (item.pq_clientid == selectedBroker || selectedBroker == 'None') {
                        if (!itemMap.has(item.srnumber)) {
                          itemMap.set(item.srnumber, []);
                        }
                        itemMap.get(item.srnumber).push(item);
                      }
                    });

                    // Iterate over the grouped items and create HTML elements
                    itemMap.forEach((items, srnumber) => {
                      var listItem = document.createElement('li');
                      listItem.classList.add('collapsible'); // Add the 'collapsible' class to the listItem

                      var contentContainer = document.createElement('div');
                      contentContainer.classList.add('content', 'collapsed'); // Add the 'content' and 'collapsed' classes to the contentContainer
                      console.log(itemMap);
                      contentContainer.id = items[0]['srnumber'];
                      createRequestDetails(items[0], contentContainer);

                        contentContainer.appendChild(document.createElement('br')); // Add a line break

                      items.forEach(item => {
                        var itemContainer = document.createElement('div');
                        //createRequestDetails(item, itemContainer);
                            itemContainer.classList.add('status-' + item['status']); // Add the 'content' and 'collapsed' classes to the contentContainer

                            valueSpan = document.createElement('span');
                            var lob_text;
                            if (item['lob'].charAt(0) === '1') {
                              lob_text = 'Auto';
                            } else if (item['lob'].charAt(0) === '2') {
                              lob_text = 'Home';
                            } else {
                              lob_text = 'Credit';
                            }

                          valueSpan.textContent = item['insurer'] + ' ' + lob_text + ' ' + item['prov'];
                          valueSpan.style.cssFloat = 'left'; // Align to the left
                          itemContainer.appendChild(valueSpan);

                          responsetimeSpan = document.createElement('span');
                          responsetimeSpan.textContent = 'Response Time: ' + item['responsetime'];
                          responsetimeSpan.style.cssFloat = 'right'; // Align to the right
                          itemContainer.appendChild(responsetimeSpan);

                            itemContainer.appendChild(document.createElement('br')); // Add a line break

                          serverSpan = document.createElement('span');
                          serverSpan.textContent = item['servername'];
                          serverSpan.style.cssFloat = 'right'; // Align to the right
                          itemContainer.appendChild(serverSpan);



                        var button3 = createDownloadButton('/process_file_location', 'Request', item.requestfile);
                        var button4 = createDownloadButton('/process_file_location', 'Response', item.responsefile);

                        // Append the buttons to the item container
                        itemContainer.appendChild(button3);
                        itemContainer.appendChild(button4);

                        // Append the item container to the content container
                        contentContainer.appendChild(itemContainer);
                      });

                      listItem.appendChild(contentContainer);
                      minuteDetailList.appendChild(listItem);

                        // Add click event listener to toggle collapsing/expanding of the list item
                        listItem.addEventListener("click", function () {
                            var listItems = document.getElementsByClassName("collapsible");
                            for (var i = 0; i < listItems.length; i++) {
                                if (listItems[i] !== this) {
                                    listItems[i].classList.remove("active");
                                    var content = listItems[i].querySelector(".content");
                                    content.classList.add("collapsed");
                                }
                            }

                            this.classList.toggle("active");
                            var content = this.querySelector(".content");
                            content.classList.toggle("collapsed");
                        });
                    });


                    });
    }

    function populateBrokerInfo(){
        console.log('populateBrokerInfo');
        var dropdownCurrentBroker = document.getElementById('current-broker-dropdown');
        var selectedCurrentBroker = dropdownCurrentBroker.value;  // Get the selected server
        selectedCurrentBroker = selectedCurrentBroker.replace(/\s/g, ""); // Remove all whitespaces

        selectedCurrentBroker = selectedCurrentBroker.split(',')[1];

        var main = document.getElementById('current-broker-details');
        main.innerHTML = ''; // Clear previous content

        if (selectedCurrentBroker !== 'None' && selectedCurrentBroker !== undefined) {
            fetch('/broker-hotfix/'+selectedCurrentBroker)
                .then(response => response.json())
                .then(data => {
                    console.log('Current Broker Hotfix:', data);
                        // Return if there is no data[0]
                        if (data[0] === undefined) {
                            return;
                        }
                      const broker_version = data[0][2];
                      const current_version = data[0][3];

                      // Check if the next two elements are the same
                      const color = (current_version === broker_version ? 'green' : 'red');

                      // Create a new div container for the span
                      const div = document.createElement('div');
                      div.style.fontWeight = 'bold';
                      div.style.color = color;

                      // Create a new span element
                      const span = document.createElement('span');
                      span.textContent = 'Installed: ' + broker_version + ' Current: ' + current_version;

                      // Append the span element to the div container
                      //div.appendChild(span);

                      // Append the div container to the main element
                      main.appendChild(div);
                });
               }

         // If selectedCurrentBroker is not 'None', fetch the broker rate engines
         console.log('selectedCurrentBroker:', selectedCurrentBroker);
         if (selectedCurrentBroker !== 'None' && selectedCurrentBroker !== undefined) {
             fetch('/broker-quick-stats/' + selectedCurrentBroker)
                  .then(response => response.json())
                  .then(data => {
                        // Create a new div container for the list
                        const listDiv = document.createElement('div');
                        listDiv.classList.add('list');
                        console.log('Current Broker:', data);
                        var itemContainer = document.createElement('div');

                        for (const item of data) {
                          if (item.includes(null)) {
                            continue; // Ignore elements containing 'null'
                          }
                            //derp
                            createBrokerDetails(item, itemContainer);
                        }
                          // Append the div container to the main element
                          main.appendChild(itemContainer);
                            console.log('itemContainer:', itemContainer);
                            console.log('itemContainer collapsible:', itemContainer.getElementsByClassName("collapsible")[0]);
                            // if there are collapsible items, toggle them
                            if (itemContainer.getElementsByClassName("collapsible")[0] !== undefined){
                                toggleCollapsible(itemContainer.getElementsByClassName("collapsible")[0],selectedCurrentBroker);
                            }

                            createQuotingHistory(selectedCurrentBroker);
                      });
             }else{
                 fetch('/broker-quick-stats/'+'None')
                      .then(response => response.json())
                      .then(data => {
                        // Reset the graph

                        // Clear details
                        var details = document.getElementById('current-broker-stats');
                        details.innerHTML = '';

                        // Create a new div container for the list
                        const listDiv = document.createElement('div');
                        listDiv.classList.add('list');
                        console.log('Current Broker:', data);
                        var itemContainer = document.createElement('div');

                        for (const item of data) {
                          if (item.includes(null)) {
                            continue; // Ignore elements containing 'null'
                          }
                            //derp
                            createBrokerDetails(item, itemContainer);
                        }
                          // Append the div container to the main element
                          main.appendChild(itemContainer);
                      });
                 }
    }

        function loadTopBrokers() {
            console.log('Loading top Brokers...');

            fetch('/top-brokers')
                .then(response => response.json())
                .then(data => {
                    var parsedData = JSON.parse(data);
                    console.log('Top Brokers:', parsedData);
                    // Get the container's size
                    var container = document.getElementById('current-broker-graph');
                    var layout = {
                        ...parsedData.layout,
                        width: container.offsetWidth,
                        height: container.offsetHeight
                    };

                    Plotly.newPlot('current-broker-graph', parsedData.data, layout)
                        .then(function(gd) {
                            gd.on('plotly_click', handleHourlyGraphClick);
                        });

                    window.dispatchEvent(new Event('resize'));  // Dispatch resize event
                });

            setTimeout(loadHourlyGraph, 60000);  // Call this function again after 1 minute
            populateBrokerInfo();

            // Add resize event listener to dynamically resize the plot
            window.addEventListener('resize', function() {
                var container = document.getElementById('current-broker-graph');
                var width = container.offsetWidth;

                Plotly.relayout('current-broker-graph', {
                    width: width
                });
            });
        }

function createBrokerDetails(item, contentContainer) {
    console.log('Creating broker details...');
    console.log('item:', item);
    // Clear the contentContainer
    //contentContainer.innerHTML = '';
    var listItem = document.createElement('li');
    listItem.classList.add('collapsible'); // Add the 'collapsible' class to the listItem
    listItem.id = item[1];

    // Check if the next two elements are the same
    const color = item[4] == item[5] ? 'green' : 'red';

    var content = document.createElement('div');
    content.classList.add('content', 'collapsed');
    listItem.appendChild(content);

    brokernameSpan = document.createElement('span');
    brokernameSpan.textContent = item[0];
    content.appendChild(brokernameSpan);

    pqClientIDSpan = document.createElement('span');
    pqClientIDSpan.textContent = item[1];
    pqClientIDSpan.style.cssFloat = 'right'; // Align to the right
    content.appendChild(pqClientIDSpan);

    content.appendChild(document.createElement('br')); // Add a line break

    installedHotfixSpan = document.createElement('span');
    installedHotfixSpan.textContent = 'Installed PQ Hotfix: ' + item[4];
    installedHotfixSpan.style.color = color;
    content.appendChild(installedHotfixSpan);

    content.appendChild(document.createElement('br')); // Add a line break

    currentHotfixSpan = document.createElement('span');
    currentHotfixSpan.textContent = 'Current PQ Hotfix: ' + item[5];
    currentHotfixSpan.style.color = color;
    content.appendChild(currentHotfixSpan);

    content.appendChild(document.createElement('br')); // Add a line break

    if (item['subbrokerid']) {
        subbrokeridSpan = document.createElement('span');
        subbrokeridSpan.textContent = 'Subbroker: ' + item['subbrokerid'];
        content.appendChild(subbrokeridSpan);
        content.appendChild(document.createElement('br')); // Add a line break
    }

    if (item['username']) {
        usernameSpan = document.createElement('span');
        usernameSpan.textContent = 'Username: ' + item['username'];
        content.appendChild(usernameSpan);
        contentContainer.appendChild(document.createElement('br')); // Add a line break (Fixed typo here)
    }

    // Add click event listener to toggle collapsing/expanding of the list item
    listItem.addEventListener("click", function () {
        toggleCollapsible(this,item[1]);
    });

    contentContainer.appendChild(listItem); // Add the item to the contentContainer
}

function toggleCollapsible(listItem,pq_clientid) {
    var listItems = document.getElementsByClassName("collapsible");
    for (var i = 0; i < listItems.length; i++) {
        if (listItems[i] !== listItem) {
            listItems[i].classList.remove("active");
            var content = listItems[i].firstElementChild;
            content.classList.add("collapsed");
        } else {
            var content = listItem.firstElementChild;
            // fetch the rate engines for the broker and display them
            createRateEngines(pq_clientid, content);
        }
    }

    listItem.classList.toggle("active");
    var content = listItem.querySelector(".content");
    content.classList.toggle("collapsed");
}

function createRateEngines(pqClientID, contentContainer) {
    createQuotingHistory(pqClientID);


    fetch('/broker-rate-engines/' + pqClientID)
      .then(response => response.json())
      .then(data => {
        console.log('Current Broker:', data);

        // Create a new div container for the list
        const listDiv = document.createElement('div');
        listDiv.classList.add('list');

        for (const item of data) {
          if (item.includes(null)) {
            continue; // Ignore elements containing 'null'
          }

          const firstThreeElements = item.slice(0, 3).join(' ').trim();
          const nextTwoElements = item.slice(3, 5);

          // Check if the next two elements are the same
          const color = (new Set(nextTwoElements)).size === 1 ? 'green' : 'red';

          // Create a new div container for the span
          const div = document.createElement('div');
          div.style.fontWeight = 'bold';
          div.style.color = color;

          // Create a new span element
          const span = document.createElement('span');
          span.textContent = firstThreeElements;
          span.style.cssFloat = 'right'; // Align to the right

          // Append the span element to the div container
          div.appendChild(span);


          // Append the div container to the main element
          listDiv.appendChild(div);
        }

          // Append the div container to the main element
          contentContainer.appendChild(listDiv);
      });
}

    function createQuotingHistory(pq_clientid){
        // Create a new div container
        const div = document.createElement('div');
        div.id = 'quoting-history';

        // Fetch the quoting history for the broker
        fetch('/broker-detailed-history/' + pq_clientid)
              .then(response => response.json())
              .then(data => {
                console.log('Current Broker History:', data);
                var container = document.getElementById('current-broker-stats');
                container.innerHTML = '';

                var chart_div = document.createElement('div');
                chart_div.id = 'quoting-history-pie-chart';
                chart_div.style.float = 'right';
                container.appendChild(chart_div);

                var parsedData = JSON.parse(data['pieChart']);

                var layout = {
                    ...parsedData.layout,
                    width: 500,
                    height: 500
                };

                Plotly.newPlot('quoting-history-pie-chart', parsedData.data, layout)
                    .then(function(gd) {
                        gd.on('plotly_click', handleHourlyGraphClick);
                    });

                var info_div = document.createElement('div');

                // Using reduce() to find the total of the second element in the nested arrays
                const total_this_year = data['quoteStatusBreakdown'].reduce((accumulator, currentArray) => {
                  return accumulator + currentArray[1];
                }, 0);

                const total_last_year = data['quoteStatusBreakdownLastYear'].reduce((accumulator, currentArray) => {
                  return accumulator + currentArray[1];
                }, 0);

                  const quoteTotalDiv = document.createElement('div');
                  quoteTotalDiv.style.cssFloat = 'right'; // Align to the right

                  // Check if the next two elements are the same
                  const color = total_this_year > total_last_year ? 'green' : 'red';

                  // Create a new div container for the span
                  const div = document.createElement('div');
                  div.style.fontWeight = 'bold';
                  div.style.color = color;

                  // Create a new span element
                  const current_monthly_span = document.createElement('span');
                  current_monthly_span.textContent = 'Current Monthly Quotes: ' + total_this_year;
                  //span.style.color = color;
                  current_monthly_span.style.color = color;
                  current_monthly_span.style.cssFloat = 'right'; // Align to the right

                   quoteTotalDiv.appendChild(current_monthly_span);

                   quoteTotalDiv.appendChild(document.createElement('br')); // Add a line break (Fixed typo here)

                   // Create a new span element
                  const previous_monthly_span = document.createElement('span');
                  previous_monthly_span.textContent = 'Historical Monthly Quotes: ' + total_last_year;
                  previous_monthly_span.style.cssFloat = 'right'; // Align to the right

                  quoteTotalDiv.appendChild(previous_monthly_span);

                  info_div.appendChild(quoteTotalDiv);

                   const usersDiv = document.createElement('div');
                   usersDiv.style.cssFloat = 'left'; // Align to the left

                   // Create a new span element
                  const actualUsersSpan = document.createElement('span');
                  actualUsersSpan.textContent = 'Active Users: ' + data['numUsersActual'];
                  actualUsersSpan.style.cssFloat = 'left'; // Align to the right

                  usersDiv.appendChild(actualUsersSpan);
                  usersDiv.appendChild(document.createElement('br')); // Add a line break (Fixed typo here)


                    // Create a new span element
                  const allowedUsersSpan = document.createElement('span');
                  allowedUsersSpan.textContent = 'Allowed Users: ' + data['numUsersAllowed'];
                  allowedUsersSpan.style.cssFloat = 'left'; // Align to the right

                  usersDiv.appendChild(allowedUsersSpan);
                  usersDiv.appendChild(document.createElement('br')); // Add a line break (Fixed typo here)
                  info_div.appendChild(usersDiv); // Add a line break (Fixed typo here)

                   container.appendChild(info_div);

                window.dispatchEvent(new Event('resize'));  // Dispatch resize event
        });
    }

    function createGraphQuotingHistory(pqClientID){
                // Clear details
                var details = document.getElementById('current-broker-graph');
                details.innerHTML = '';

                fetch('/broker-quoting-history/' + pqClientID)
                .then(response => response.json())
                .then(data => {
                    var parsedData = JSON.parse(data);
                    Plotly.newPlot('current-broker-graph', parsedData.data, parsedData.layout)
                        .then(function(gd) {
                            gd.on('plotly_click', handleBarClick);
                        });
                });
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadBrokers();
        loadBarGraph();
        loadHourlyGraph();  // Add this line
        populateCurrentBroker();
        loadTopBrokers();

        var backButton = document.getElementById('back-button');
        backButton.addEventListener('click', handleBackButtonClick);

        var mainTab = document.getElementById('request-per-hour-button');
        mainTab.addEventListener('click', handleBackButtonClick);

        var dropdown = document.getElementById('broker-dropdown');
        dropdown.addEventListener('change', refilter);

        var dropdown = document.getElementById('current-broker-dropdown');
        dropdown.addEventListener('change', populateBrokerInfo);

        var serverDropdown = document.getElementById('server-dropdown');
        serverDropdown.addEventListener('change', handleServerDropDownChange);

        // Function to update health check status and color
        function updateHealthCheckStatus() {
            fetch('/health-check')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('health-check-status-container');
                    // Clear the container before adding new messages
                    container.innerHTML = '';

                    // Loop through each message in the response
                    data.messages.forEach(msg => {
                        const span = document.createElement('span');
                        span.textContent = msg.status;
                        span.style.color = msg.color;
                        span.style.fontWeight = 'bold'; // Example of applying additional styling
                        // Add a little space or a new line after each span if desired
                        //span.style.display = 'block'; // Makes each span appear on a new line

                        container.appendChild(span);
                    });
                })
                .catch(error => console.error('Error fetching health check statuses:', error));
        }


        // Update health check status every 30 seconds
        setInterval(updateHealthCheckStatus, 30000);

        // Initial update on page load
        updateHealthCheckStatus();
    });

</script>
</body>
</html>
